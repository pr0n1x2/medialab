# Задание 3

**Проблема:**

Состоит в том, что операция DELETE применяется к каждой строчке в БД, если в таблице есть индексы приходится перестраивать таблицу индексов. Тем самым если мы применим к базе следующий запрос:

```
DELETE FROM table WHERE create_at < 'date';
```

такой запрос будет выполняться довольно долго!

**Решение:**

Нужно разделить таблицу на PARTITION BY HASH на основе даты, будем разбивать таблицу по месяцам.

Тем самым мы будем удалять данные целыми секциями, а не построчно. Выигрыш в производительности будет огромен.

**Подробное описание решения:**

- Создаем аналогичную таблицу logs только добавляем в нее PARTITION BY HASH на основе даты по месяцам

```
CREATE TABLE `logs` (
  `log` varchar(20) NOT NULL,
  `created_at` datetime NOT NULL,
  UNIQUE KEY `created` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 
PARTITION BY HASH ( MONTH(created_at) ) PARTITIONS 12;
```

- В коде начинаем записывать данные в 2е таблицы
- По истечению месяца, когда в созданной нами таблице накопятся данные, мы удаляем основную таблицу и даем имя нашей таблице такое же какое было у оригинальной.
- Удаляем из кода лишнию таблицу.
- Раз в месяц мы назначаем задание для cron. В этом скрипте мы будем определять прошедший месяц и удалять соответствующею партицию, например если сейчас 8й месяц, нам  нужно сохранить данные за 7й месяц и удалить 6й

 ```
 ALTER TABLE logs TRUNCATE PARTITION p6;
 ```
 
 - Таким образом удаление данных из базы происходит практически мгновенно.
 - Если же нам нужно удалить все данные не старше одного месяца на текущий день, тогда удаляем все лишние партиции и применяем следующий запрос к базе:
 
```
DELETE FROM logs WHERE create_at < 'date';
```